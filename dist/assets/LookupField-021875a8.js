import{B as ye,s as ke,a3 as ge,a4 as he,r as f,a as xe,E as _e,a7 as e,q as ee,b1 as be,c as N,V as Se,o as l,j as i,W as le,n as O,i as t,F as y,k as V,d as h,w as x,g as te,t as m,e as d,x as B,m as P,f as F,aF as Ve,c2 as oe,I as we,J as Ce}from"./index-9c0f0a49.js";const Ne={key:1,class:"flex align-items-center lookupSelected",style:{width:"100%"}},Fe={class:"flex justify-content-between lookupSelected",style:{width:"100%"}},Ee={class:"flex flex-colum ml-2 lookupSelected"},De=d("i",{class:"pi pi-times lookupRemoveBtn"},null,-1),Le=[De],Be={class:"flex align-items-center lookupSelection"},Pe={class:"lookupSelection"},Ae={key:0,class:"font-medium lookupSelection"},Re={key:1,class:"text-sm text-color-secondary lookupSelection"},je={class:"flex align-items-center lookupSelection"},Te={class:"lookupSelection"},Ue={key:0,class:"font-medium lookupSelection"},Me={key:1,class:"text-sm text-color-secondary lookupSelection"},ze={class:"flex justify-content-center"},Ie={class:"flex flex-column mt-1"},Oe={key:1,class:"lookupField"},Ge={class:"flex align-items-center lookupSelection"},qe={class:"lookupSelection"},$e={key:0,class:"font-medium lookupSelection"},Ke={key:1,class:"text-sm text-color-secondary lookupSelection"},Qe={class:"flex align-items-center lookupSelection"},Je={class:"lookupSelection"},We={key:0,class:"font-medium lookupSelection"},Ze={key:1,class:"text-sm text-color-secondary lookupSelection"},He={class:"flex justify-content-center"},Xe={class:"flex flex-column mt-1"},el={__name:"LookupField",props:{field:Object,keyName:String,module:String,inline:Boolean,entity:String,formField:Boolean,modelValue:Array,optionValue:String,onLoad:Boolean},emits:["changeValue","update:modelValue"],setup(s,{emit:ae}){const ne=ye(),{getModules:Q,getModuleByName:ie}=ke(ne),se=ge(),{fetchLookupPaginated:ue}=se,{formatLookupOptions:de,extractFieldinExpressionFormat:ce,extractEntityinExpressionFormat:re}=he(),me=we(()=>Ce(()=>import("./AddableForm-70604fa0.js"),["assets/AddableForm-70604fa0.js","assets/index-9c0f0a49.js","assets/index-40ff91a8.css","assets/Validate-ab398f9d.js","assets/index-e220ff77.js"])),k=f({}),g=f(),E=f(""),_=f({}),G=f({}),w=f(!1),D=f(1),A=f(!0),b=f(!1),R=async r=>{w.value||(w.value=!0,M())},j=f([]),pe=xe(),T=f(!1),J=f([]),o=s,q=ae,W=f(null);_e(()=>{if(e.get(o.field,"rules.ms_pop_up",!1)&&(b.value=!0),o.formField||(b.value=!0),k.value=e.find(Q.value,{mainEntity:o.field.relation.entity_id.name}),e.has(o.field,"filterQuery")){var r=o.field.filterQuery,n=r.match(/(\%[a-zA-Z0-9_\:\.\#]*\%)/gi);e.forEach(n,function(u){var S=e.trim(u,"%"),I=ce(S),C=re(S);e.isEmpty(C)&&(C=e.find(Q.value,{name:o.module}).mainEntity),C==o.entity&&j.value.push({field:I,entity:C})})}e.has(o.field,"rules.filtered_by")&&(e.isEmpty(o.field.rules.filtered_by)||j.value.push({field:o.field.rules.filtered_by,entity:o.entity})),console.log(o.onLoad),o.onLoad&&M()});const Z=async r=>{D.value=r,M()},$=()=>{w.value=!1};let U=null;const M=async()=>{A.value=!0,U&&U.cancel("Previous search canceled"),U=ee.CancelToken.source();try{let r={fieldId:o.field.uniqueName,page:D.value,moduleName:o.module,search:E.value},n=[];if(o.formField||(r.forReport=!0),!e.isEmpty(j.value)&&o.formField&&e.forEach(j.value,function(u){if(!e.isEmpty(p.value.values.main[u.field])&&!e.isNull(p.value.values.main[u.field])){let S=u.entity+"::"+u.field;r[S]=e.isArray(p.value.values.main[u.field])?e.map(p.value.values.main[u.field],"_id"):p.value.values.main[u.field]._id}else n.push(u.field)}),e.isEmpty(n)){let u=await ue(r,U);_.value=de(u.data,[],o.field),G.value=e.cloneDeep(e.get(u,"meta.pagination",{})),J.value=_.value.options.filter(S=>o.modelValue&&o.modelValue.includes(S._id)),g.value=J.value}else pe.add({severity:"error",summary:"Error",detail:"Please select "+e.join(n,", "),position:"top-center",life:3e3});A.value=!1}catch(r){ee.isCancel(r)?console.log("Request canceled:",r.message):console.error("Error fetching data:",r)}},H=async()=>{D.value=1,await M()},K=r=>{b.value?o.formField?e.remove(p.value.values[o.keyName][o.field.name],function(n,u){return u==r}):e.remove(g.value,function(n,u){return u==r}):p.value.values[o.keyName][o.field.name]=null,q("changeValue")},z=r=>{if(b.value||$(),!o.formField){let n=null;o.optionValue?n=g.value.map(u=>u[o.optionValue]):n=g.value,q("update:modelValue",n)}q("changeValue")},ve=async()=>{W.value=ie.value(o.field.addable.moduleName),T.value=!0},p=o.formField?be("form"):{};return(r,n)=>{const u=N("el-tag"),S=N("el-button"),I=N("el-input"),C=N("Skeleton"),L=N("Listbox"),X=N("el-pagination"),fe=N("Dialog"),Y=Se("click-outside");return l(),i(y,null,[s.formField?le((l(),i("div",{key:0,class:O(["lookupField",{invalid:!t(e).isEmpty(t(e).get(t(p).errors[s.keyName],s.field.name,[]))}])},[t(e).isEmpty(t(p).values[s.keyName][s.field.name])?P("",!0):(l(),i("div",{key:0,class:O(["selectedValue",b.value?"multiple":"single flex align-items-center"]),onClick:R},[b.value?(l(!0),i(y,{key:0},V(g.value,(a,c)=>(l(),h(u,{class:"mr-1",closable:"",key:a.value,onClose:v=>K(c)},{default:x(()=>[te(m(a.value),1)]),_:2},1032,["onClose"]))),128)):(l(),i("div",Ne,[d("div",{class:"material-icons text-white ml-2 lookupSelected",style:B("background:"+t(e).get(k.value,"color","#0091D0"))},m(t(e).get(k.value,"icon","person")),5),d("div",Fe,[d("span",Ee,m(t(p).values[s.keyName][s.field.name].value),1),d("span",{class:"flex flex-colum mr-2 lookupRemoveBtn",onClick:K},Le)])]))],2)),F(I,{modelValue:E.value,"onUpdate:modelValue":n[0]||(n[0]=a=>E.value=a),onClick:R,onKeyup:H,class:"lookupInput",disabled:t(p).formSaving,placeholder:"Please search here","suffix-icon":t(oe)},Ve({_:2},[s.field.addable?{name:"append",fn:x(()=>[F(S,null,{default:x(()=>[d("i",{class:"pi pi-plus",onClick:ve})]),_:1})]),key:"0"}:void 0]),1032,["modelValue","disabled","suffix-icon"]),w.value?(l(),i("div",{key:1,class:O(["lookupOverlay p-overlaypanel p-component",{open:w.value==!0,"w-full":!s.inline,"w-auto":s.inline}])},[A.value?(l(!0),i(y,{key:0},V(t(e).fill(Array(10),"i"),(a,c)=>(l(),h(C,{key:c,height:"2rem",width:s.inline?"300px":"100%",class:"m-2",borderRadius:"5px"},null,8,["width"]))),128)):_.value.group?(l(),h(L,{key:1,modelValue:t(p).values[s.keyName][s.field.name],"onUpdate:modelValue":[n[1]||(n[1]=a=>t(p).values[s.keyName][s.field.name]=a),z],multiple:b.value,options:t(e).get(_.value,"options",[]),optionLabel:"value",optionGroupLabel:"label",optionGroupChildren:"options",listStyle:"max-height:300px"},{option:x(a=>[d("div",Be,[d("div",{class:"material-icons text-white mr-2 lookupSelection",style:B("background:"+t(e).get(k.value,"color","#0091D0"))},m(t(e).get(k.value,"icon","person")),5),d("div",Pe,[(l(!0),i(y,null,V(a.option.poupDisplayValues,(c,v)=>(l(),i(y,{key:v},[v==0?(l(),i("span",Ae,m(c),1)):(l(),i("div",Re,m(c),1))],64))),128))])])]),_:1},8,["modelValue","multiple","options"])):(l(),h(L,{key:2,modelValue:t(p).values[s.keyName][s.field.name],"onUpdate:modelValue":[n[2]||(n[2]=a=>t(p).values[s.keyName][s.field.name]=a),z],multiple:b.value,options:t(e).get(_.value,"options",[]),optionLabel:"value",listStyle:"max-height:300px"},{option:x(a=>[d("div",je,[d("div",{class:"material-icons text-white mr-2 lookupSelection",style:B("background:"+t(e).get(k.value,"color","#0091D0"))},m(t(e).get(k.value,"icon","person")),5),d("div",Te,[(l(!0),i(y,null,V(a.option.poupDisplayValues,(c,v)=>(l(),i(y,{key:v},[v==0?(l(),i("span",Ue,m(c),1)):(l(),i("div",Me,m(c),1))],64))),128))])])]),_:1},8,["modelValue","multiple","options"])),d("div",ze,[d("div",Ie,[F(X,{small:"",background:"",layout:"prev, pager, next","default-page-size":10,"current-page":D.value,total:t(e).get(G.value,"total",0),onCurrentChange:Z},null,8,["current-page","total"])])])],2)):P("",!0)],2)),[[Y,$]]):le((l(),i("div",Oe,[t(e).isEmpty(g.value)?P("",!0):(l(),i("div",{key:0,class:"selectedValue multiple",onClick:R},[(l(!0),i(y,null,V(g.value,(a,c)=>(l(),h(u,{class:"mr-1",closable:"",key:a.value,onClose:v=>K(c)},{default:x(()=>[te(m(a.value),1)]),_:2},1032,["onClose"]))),128))])),F(I,{modelValue:E.value,"onUpdate:modelValue":n[3]||(n[3]=a=>E.value=a),onClick:R,onKeyup:H,class:"lookupInput",placeholder:"Please search here","suffix-icon":t(oe)},null,8,["modelValue","suffix-icon"]),w.value?(l(),i("div",{key:1,class:O(["lookupOverlay p-overlaypanel p-component",{open:w.value==!0,"w-full":!s.inline,"w-auto":s.inline}])},[A.value?(l(!0),i(y,{key:0},V(t(e).fill(Array(10),"i"),(a,c)=>(l(),h(C,{key:c,height:"2rem",width:s.inline?"300px":"100%",class:"m-2",borderRadius:"5px"},null,8,["width"]))),128)):_.value.group?(l(),h(L,{key:1,modelValue:g.value,"onUpdate:modelValue":[n[4]||(n[4]=a=>g.value=a),z],multiple:!0,options:t(e).get(_.value,"options",[]),optionLabel:"value",optionGroupLabel:"label",optionGroupChildren:"options",listStyle:"max-height:300px"},{option:x(a=>[d("div",Ge,[d("div",{class:"material-icons text-white mr-2 lookupSelection",style:B("background:"+t(e).get(k.value,"color","#0091D0"))},m(t(e).get(k.value,"icon","person")),5),d("div",qe,[(l(!0),i(y,null,V(a.option.poupDisplayValues,(c,v)=>(l(),i(y,{key:v},[v==0?(l(),i("span",$e,m(c),1)):(l(),i("div",Ke,m(c),1))],64))),128))])])]),_:1},8,["modelValue","options"])):(l(),h(L,{key:2,modelValue:g.value,"onUpdate:modelValue":[n[5]||(n[5]=a=>g.value=a),z],multiple:!0,options:t(e).get(_.value,"options",[]),optionLabel:"value",listStyle:"max-height:300px"},{option:x(a=>[d("div",Qe,[d("div",{class:"material-icons text-white mr-2 lookupSelection",style:B("background:"+t(e).get(k.value,"color","#0091D0"))},m(t(e).get(k.value,"icon","person")),5),d("div",Je,[(l(!0),i(y,null,V(a.option.poupDisplayValues,(c,v)=>(l(),i(y,{key:v},[v==0?(l(),i("span",We,m(c),1)):(l(),i("div",Ze,m(c),1))],64))),128))])])]),_:1},8,["modelValue","options"])),d("div",He,[d("div",Xe,[F(X,{small:"",background:"",layout:"prev, pager, next","default-page-size":10,"current-page":D.value,total:t(e).get(G.value,"total",0),onCurrentChange:Z},null,8,["current-page","total"])])])],2)):P("",!0)])),[[Y,$]]),s.field.addable?(l(),h(fe,{key:2,visible:T.value,"onUpdate:visible":n[7]||(n[7]=a=>T.value=a),modal:"",header:"New "+t(e).startCase(t(e).get(W.value,"name","")),style:{width:"40vw"},draggable:"",breakpoints:{"1199px":"75vw","575px":"90vw"}},{default:x(()=>[F(t(me),{moduleName:s.field.addable.moduleName,formPage:"create",onClose:n[6]||(n[6]=a=>T.value=!1)},null,8,["moduleName"])]),_:1},8,["visible","header"])):P("",!0)],64)}}};export{el as default};
