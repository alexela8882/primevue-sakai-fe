import{B as re,s as me,a3 as ve,a4 as fe,I as pe,J as ye,r as m,a as ke,E as ge,a7 as e,aY as he,c as k,V as xe,o as a,j as d,W as _e,n as M,i as l,F as g,k as F,d as N,w as b,g as be,t as f,e as r,x as R,m as z,f as L,aA as Se,bZ as Ne,q as J}from"./index-2f40471b.js";const Ve={key:1,class:"flex align-items-center lookupSelected",style:{width:"100%"}},we={class:"flex justify-content-between lookupSelected",style:{width:"100%"}},Ee={class:"flex flex-colum ml-2 lookupSelected"},Ce=r("i",{class:"pi pi-times lookupRemoveBtn"},null,-1),De=[Ce],Fe={class:"flex align-items-center lookupSelection"},Le={class:"lookupSelection"},Be={key:0,class:"font-medium lookupSelection"},Pe={key:1,class:"text-sm text-color-secondary lookupSelection"},Ae={class:"flex align-items-center lookupSelection"},Te={class:"lookupSelection"},je={key:0,class:"font-medium lookupSelection"},Me={key:1,class:"text-sm text-color-secondary lookupSelection"},Re={class:"flex justify-content-center"},ze={class:"flex flex-column mt-1"},Oe={__name:"LookupField",props:{field:Object,keyName:String,module:String,inline:Boolean,entity:String},emits:["changeValue"],setup(t,{emit:I}){const o=t,K=re(),{getModules:O,getModuleByName:W}=me(K),Y=ve(),{fetchLookupPaginated:H}=Y,{formatLookupOptions:X,extractFieldinExpressionFormat:ee,extractEntityinExpressionFormat:le}=fe(),te=pe(()=>ye(()=>import("./AddableForm-d821f0e0.js"),["assets/AddableForm-d821f0e0.js","assets/index-2f40471b.js","assets/index-d5e7f8f7.css","assets/Validate-1e200014.js","assets/index-82b5396b.js"])),p=m({}),ae=m(),B=m(""),V=m({}),U=m({}),S=m(!1),w=m(1),P=m(!0),y=m(!1),q=async c=>{S.value||(S.value=!0,A())},E=m([]),oe=ke(),C=m(!1),G=m(null);ge(()=>{if(e.get(o.field,"rules.ms_pop_up",!1)&&(y.value=!0),p.value=e.find(O.value,{mainEntity:o.field.relation.entity_id.name}),e.has(o.field,"filterQuery")){var c=o.field.filterQuery,n=c.match(/(\%[a-zA-Z0-9_\:\.\#]*\%)/gi);e.forEach(n,function(i){var h=e.trim(i,"%"),T=ee(h),x=le(h);e.isEmpty(x)&&(x=e.find(O.value,{name:o.module}).mainEntity),x==o.entity&&E.value.push({field:T,entity:x})})}e.has(o.field,"rules.filtered_by")&&(e.isEmpty(o.field.rules.filtered_by)||E.value.push({field:o.field.rules.filtered_by,entity:o.entity}))});const ne=async c=>{w.value=c,A()},Q=()=>{S.value=!1};let D=null;const A=async()=>{P.value=!0,D&&D.cancel("Previous search canceled"),D=J.CancelToken.source();try{let c={fieldId:o.field.uniqueName,page:w.value,moduleName:o.module,search:B.value},n=[];if(e.isEmpty(E.value)||e.forEach(E.value,function(i){if(!e.isEmpty(u.value.values.main[i.field])&&!e.isNull(u.value.values.main[i.field])){let h=i.entity+"::"+i.field;c[h]=e.isArray(u.value.values.main[i.field])?e.map(u.value.values.main[i.field],"_id"):u.value.values.main[i.field]._id}else n.push(i.field)}),e.isEmpty(n)){let i=await H(c,D);V.value=X(i.data,[],o.field),U.value=e.cloneDeep(e.get(i,"meta.pagination",{}))}else oe.add({severity:"error",summary:"Error",detail:"Please select "+e.join(n,", "),position:"top-center",life:3e3});P.value=!1}catch(c){J.isCancel(c)?console.log("Request canceled:",c.message):console.error("Error fetching data:",c)}},ie=async()=>{w.value=1,await A()},Z=c=>{y.value?e.remove(u.value.values[o.keyName][o.field.name],function(n,i){return i==c}):u.value.values[o.keyName][o.field.name]=null,I("changeValue")},$=c=>{y.value||Q(),I("changeValue")},se=async()=>{G.value=W.value(o.field.addable.moduleName),C.value=!0},u=he("form");return(c,n)=>{const i=k("el-tag"),h=k("el-button"),T=k("el-input"),x=k("Skeleton"),j=k("Listbox"),ue=k("el-pagination"),ce=k("Dialog"),de=xe("click-outside");return a(),d(g,null,[_e((a(),d("div",{class:M(["lookupField",{invalid:!l(e).isEmpty(l(e).get(l(u).errors[t.keyName],t.field.name,[]))}])},[l(e).isEmpty(l(u).values[t.keyName][t.field.name])?z("",!0):(a(),d("div",{key:0,class:M(["selectedValue",y.value?"multiple":"single flex align-items-center"]),onClick:q},[y.value?(a(!0),d(g,{key:0},F(ae.value,(s,v)=>(a(),N(i,{class:"mr-1",closable:"",key:s.value,onClose:_=>Z(v)},{default:b(()=>[be(f(s.value),1)]),_:2},1032,["onClose"]))),128)):(a(),d("div",Ve,[r("div",{class:"material-icons text-white ml-2 lookupSelected",style:R("background:"+l(e).get(p.value,"color","#0091D0"))},f(l(e).get(p.value,"icon","person")),5),r("div",we,[r("span",Ee,f(l(u).values[t.keyName][t.field.name].value),1),r("span",{class:"flex flex-colum mr-2 lookupRemoveBtn",onClick:Z},De)])]))],2)),L(T,{modelValue:B.value,"onUpdate:modelValue":n[0]||(n[0]=s=>B.value=s),onClick:q,onKeyup:ie,class:"lookupInput",disabled:l(u).formSaving,placeholder:"Please search here","suffix-icon":l(Ne)},Se({_:2},[t.field.addable?{name:"append",fn:b(()=>[L(h,null,{default:b(()=>[r("i",{class:"pi pi-plus",onClick:se})]),_:1})]),key:"0"}:void 0]),1032,["modelValue","disabled","suffix-icon"]),S.value?(a(),d("div",{key:1,class:M(["lookupOverlay p-overlaypanel p-component",{open:S.value==!0,"w-full":!t.inline,"w-auto":t.inline}])},[P.value?(a(!0),d(g,{key:0},F(l(e).fill(Array(10),"i"),(s,v)=>(a(),N(x,{key:v,height:"2rem",width:t.inline?"300px":"100%",class:"m-2",borderRadius:"5px"},null,8,["width"]))),128)):V.value.group?(a(),N(j,{key:1,modelValue:l(u).values[t.keyName][t.field.name],"onUpdate:modelValue":[n[1]||(n[1]=s=>l(u).values[t.keyName][t.field.name]=s),$],multiple:y.value,options:l(e).get(V.value,"options",[]),optionLabel:"value",optionGroupLabel:"label",optionGroupChildren:"options",listStyle:"max-height:300px"},{option:b(s=>[r("div",Fe,[r("div",{class:"material-icons text-white mr-2 lookupSelection",style:R("background:"+l(e).get(p.value,"color","#0091D0"))},f(l(e).get(p.value,"icon","person")),5),r("div",Le,[(a(!0),d(g,null,F(s.option.poupDisplayValues,(v,_)=>(a(),d(g,{key:_},[_==0?(a(),d("span",Be,f(v),1)):(a(),d("div",Pe,f(v),1))],64))),128))])])]),_:1},8,["modelValue","multiple","options"])):(a(),N(j,{key:2,modelValue:l(u).values[t.keyName][t.field.name],"onUpdate:modelValue":[n[2]||(n[2]=s=>l(u).values[t.keyName][t.field.name]=s),$],multiple:y.value,options:l(e).get(V.value,"options",[]),optionLabel:"value",listStyle:"max-height:300px"},{option:b(s=>[r("div",Ae,[r("div",{class:"material-icons text-white mr-2 lookupSelection",style:R("background:"+l(e).get(p.value,"color","#0091D0"))},f(l(e).get(p.value,"icon","person")),5),r("div",Te,[(a(!0),d(g,null,F(s.option.poupDisplayValues,(v,_)=>(a(),d(g,{key:_},[_==0?(a(),d("span",je,f(v),1)):(a(),d("div",Me,f(v),1))],64))),128))])])]),_:1},8,["modelValue","multiple","options"])),r("div",Re,[r("div",ze,[L(ue,{small:"",background:"",layout:"prev, pager, next","default-page-size":10,"current-page":w.value,total:l(e).get(U.value,"total",0),onCurrentChange:ne},null,8,["current-page","total"])])])],2)):z("",!0)],2)),[[de,Q]]),t.field.addable?(a(),N(ce,{key:0,visible:C.value,"onUpdate:visible":n[4]||(n[4]=s=>C.value=s),modal:"",header:"New "+l(e).startCase(l(e).get(G.value,"name","")),style:{width:"40vw"},draggable:"",breakpoints:{"1199px":"75vw","575px":"90vw"}},{default:b(()=>[L(l(te),{moduleName:t.field.addable.moduleName,formPage:"create",onClose:n[3]||(n[3]=s=>C.value=!1)},null,8,["moduleName"])]),_:1},8,["visible","header"])):z("",!0)],64)}}};export{Oe as default};
