import{M as se,r,v as L,q as j,I as oe,J as ie,B as ue,O as me,s as x,a4 as pe,E as ce,a7 as e,c as R,o as w,j as C,f as _,m as V,F as Z,e as H,i as ee,d as re}from"./index-2f40471b.js";import{u as te}from"./index-82b5396b.js";const de=se("quotePDF",()=>{te();const B=r([]),N=r([]),h=r({}),M=L(()=>B.value),E=L(()=>N.value),U=L(()=>h.value);return{getTemplates:M,getQuoteInfo:U,getCurrentTemplate:E,fetchQuoteTemplates:async()=>{const m=await j.get("/quotationtemplates");m.status===200&&(B.value=m.data)},fetchQuoteTemplate:async m=>{const g=await j.get(`/quotationtemplates/${m}`);g.status===200&&(N.value=g.data)},fetchQuoteTemplatesInfo:async m=>{console.log({_id:m});const d=await j.get(`/quotationtemplates/getInfo/${m}`);d.status===200&&(h.value=d.data)}}});const fe={key:0,class:"flex align-items-center justify-content-center",style:{height:"60vh !important"}},ye={class:"flex justify-content-between"},ve={class:"flex"},_e={class:"pdfPreview w-full mt-2 card flex"},he={key:0,class:"flex align-items-center justify-content-center",style:{height:"60vh !important"}},Ne={__name:"QuotePDFPreview",setup(B){const N=oe(()=>ie(()=>import("./PDFPage-e5b29f89.js"),["assets/PDFPage-e5b29f89.js","assets/index-2f40471b.js","assets/index-d5e7f8f7.css","assets/PDFPage-dbfec3c0.css"])),h=de(),M=te(),E=ue(),U=me(),{fetchQuoteTemplates:$,fetchQuoteTemplatesInfo:J,fetchQuoteTemplate:z}=h,{getTemplates:m,getCurrentTemplate:g,getQuoteInfo:d}=x(h),{getItem:S,_getRelatedLists:ae}=x(M),{fetchModuleFields:D}=E,{getEntityFields:T,getModuleByName:f}=x(E),{getAuthUser:G}=x(U),{transformLookupDisplay:K,transformNumberCurrency:q}=pe(),b=r(null),A=r(!0),I=r(!1),W=r({headerPanel:[],bodyPanel:[],footerPanel:[]});ce(async()=>{await $(),await J(S.value.data._id),e.isEmpty(f.value("accounts").fields)&&await D("Account"),e.isEmpty(f.value("salesopportunities").fields)&&await D("SalesOpportunity"),e.isEmpty(T.value("SalesOpptItem"))&&await D("SalesOpptItem"),e.isEmpty(T.value("User"))&&await D("User"),A.value=!1});const le=async()=>{I.value=!0,await z(b.value._id),await ne(),I.value=!1,X()},X=()=>{const p=document.getElementById("pdfContent");if(console.log(p),p){const y=p.offsetHeight;console.log(y)}},ne=async()=>{let p=e.get(S.value.data,"currency_id.code","");e.forEach(g.value.pages[0],function(y,F){let P=[];e.forEach(y,function(v,Y){let O=[];e.forEach(v.sections,function(Q,ge){let c=[];e.forEach(Q.elements,function(t,Te){if(t.elemType=="field"){let a={},n={};if(t.value.entityName=="Account"||t.value.entityName=="SalesOpportunity"){let l=t.value.entityName=="Account"?"accounts":"salesopportunities";a=e.find(f.value(l).fields,{_id:t.value.source}),n=e.cloneDeep(d.value[t.value.entityName])}else t.value.entityName=="User"?(a=e.find(T.value("User").fields,{_id:t.value.source}),n=e.cloneDeep(G.value)):t.value.entityName=="SalesQuote"&&(a=e.find(f.value("salesquotes").fields,{_id:t.value.source}),n=e.cloneDeep(S.value.data));if(a){if(!e.isEmpty(e.get(n,a.name,""))&&!e.isNull(e.get(n,a.name,"")))if(a.field_type.name=="lookupModel"){let l=K(n[a.name],a);c.push({elemType:t.elemType,fieldType:a.field_type.name,label:t.label.value,value:l.label})}else c.push({elemType:t.elemType,fieldType:a.field_type.name,label:t.label.value,value:n[a.name]});else if(e.includes(["percentage","number","currency","formula","rollUpSummary"],a.field_type.name)){let l=e.isString(n[a.name])?e.toNumber(n[a.name]):e.isNumber(n[a.name])?n[a.name]:0;a.field_type.name=="percentage"?l=l*100+"%":l=(a.field_type.name=="currency"||e.get(a,"formulaType","")=="currency")&&p?p+" "+q(l,a.rules,!0):q(l,a.rules,!0),c.push({elemType:t.elemType,fieldType:a.field_type.name,label:t.label.value,value:l})}}}else if(t.elemType=="groupField"){let a=[],n={};if(t.entityName=="Account"||t.entityName=="SalesOpportunity"){let l=t.entityName=="Account"?"accounts":"salesopportunities";a=e.filter(f.value(l).fields,function(u){if(e.includes(t.fields,u._id))return!0}),n=e.cloneDeep(d.value[t.value.entityName])}else t.entityName=="User"?(a=e.filter(T.value("User"),function(l){if(e.includes(t.fields,l._id))return!0}),n=e.cloneDeep(G.value)):t.entityName=="SalesQuote"&&(a=e.filter(f.value("salesquotes").fields,function(l){if(e.includes(t.fields,l._id))return!0}),n=e.cloneDeep(S.value.data));if(!e.isEmpty(a)){let l={};e.forEach(a,function(u){if(u.field_type.name=="lookupModel"){let i=K(n[u.name],u);l[u.name]=i.label}else l[u.name]=n[u.name]}),c.push({elemType:t.elemType,fieldType:"groupField",label:t.label.value,value:e.join(e.values(e.pick(l,e.map(a,"name")))," ")})}}else if(t.elemType=="mutable"){let a=[];e.forEach(t.fields,function(i){let o=e.find(T.value("SalesOpptItem"),{_id:i.fieldID});if(o)if(o.field_type.name=="lookupModel")a.push({name:o.name,field:o,label:i.label,width:i.width,displayFieldName:i.displayFieldName[0]});else{let s=(o.field_type.name=="currency"||e.get(o,"formulaType","")=="currency")&&p?i.label+" ("+p+")":i.label;a.push({name:o.name,field:o,label:s,width:i.width,displayFieldName:o.name})}});let n=e.find(ae.value,{cname:"salesopptitem-panel-2"}),l=e.cloneDeep(d.value.Product.collection),u=[];n&&e.forEach(e.get(n,"collection.data",[]),function(i){let o={};e.forEach(a,function(s){if(s.name=="product_id"){let k=e.find(l,{_id:i.product_id._id});k&&(o[s.displayFieldName]=k[s.displayFieldName])}else if(e.includes(["percentage","number","currency","formula","rollUpSummary"],s.field.field_type.name))if(o[s.name]=e.isString(i[s.name])?e.toNumber(i[s.name]):e.isNumber(i[s.name])?i[s.name]:0,s.field.field_type.name=="percentage"){let k=o[s.name]*100;o[s.name]=k+"%"}else o[s.name]=q(o[s.name],s.field.rules,!0);else o[s.name]=i[s.name]}),u.push(o)}),c.push({elemType:t.elemType,type:t.type,fields:a,values:u})}else t.elemType=="label"?c.push({elemType:t.elemType,value:t.value,style:t.style}):t.elemType=="richTextbox"&&c.push({elemType:t.elemType,value:t.html})}),e.isEmpty(c)||O.push({alignment:Q.alignment,width:Q.width,label:e.get(Q,"label",""),elements:c})}),e.isEmpty(O)||P.push({label:v.label,sections:O})}),W.value[F]=P})};return(p,y)=>{const F=R("ProgressSpinner"),P=R("Dropdown"),v=R("Button");return w(),C(Z,null,[A.value?(w(),C("div",fe,[_(F)])):V("",!0),A.value?V("",!0):(w(),C(Z,{key:1},[H("div",ye,[_(P,{modelValue:b.value,"onUpdate:modelValue":y[0]||(y[0]=Y=>b.value=Y),options:ee(m),filter:"",optionLabel:"name",placeholder:"Select a template",class:"w-full md:w-14rem",onChange:le},null,8,["modelValue","options"]),H("div",ve,[_(v,{icon:"pi pi-save",rounded:"","aria-label":"Save"}),_(v,{icon:"pi pi-download",rounded:"",class:"ml-2","aria-label":"Download"}),_(v,{icon:"pi pi-envelope",rounded:"",class:"ml-2","aria-label":"Email"})])]),H("div",_e,[I.value?(w(),C("div",he,[_(F)])):V("",!0),b.value&&!I.value?(w(),re(ee(N),{key:1,selectedTemplate:b.value,pageContent:W.value,onMounted:X},null,8,["selectedTemplate","pageContent"])):V("",!0)])],64))],64)}}};export{Ne as default};
