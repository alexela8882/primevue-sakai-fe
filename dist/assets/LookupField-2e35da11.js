import{B as ye,s as ge,a4 as ke,a5 as he,r as g,a as xe,E as _e,a2 as e,q as ee,b2 as be,c as N,V as Se,o,j as n,W as le,n as R,i as l,F as k,k as C,d as b,w as S,g as te,t as f,e as r,x as j,m as D,f as L,aG as Ve,c3 as oe,I as we,J as Ce}from"./index-f956d2f5.js";const Fe={key:1,class:"flex align-items-center lookupSelected",style:{width:"100%"}},Ne={class:"flex justify-content-between align-items-center lookupSelected",style:{width:"100%"}},Ee={class:"flex flex-colum ml-2 lookupSelected"},De=r("i",{class:"pi pi-times lookupRemoveBtn"},null,-1),Le=[De],Be={class:"flex align-items-center lookupSelection"},Ae={class:"lookupSelection"},Pe={key:0,class:"font-medium lookupSelection"},Re={key:1,class:"text-sm text-color-secondary lookupSelection"},je={class:"flex align-items-center lookupSelection"},Te={class:"lookupSelection"},Ue={key:0,class:"font-medium lookupSelection"},Me={key:1,class:"text-sm text-color-secondary lookupSelection"},ze={class:"flex justify-content-center"},Ge={class:"flex flex-column mt-1"},Ie={key:1,class:"lookupField"},Oe={class:"flex align-items-center lookupSelection"},Ke={class:"lookupSelection"},qe={key:0,class:"font-medium lookupSelection"},$e={key:1,class:"text-sm text-color-secondary lookupSelection"},Qe={class:"flex align-items-center lookupSelection"},Je={class:"lookupSelection"},We={key:0,class:"font-medium lookupSelection"},Ze={key:1,class:"text-sm text-color-secondary lookupSelection"},He={class:"flex justify-content-center"},Xe={class:"flex flex-column mt-1"},el={__name:"LookupField",props:{field:Object,keyName:String,module:String,inline:Boolean,entity:String,formField:Boolean,modelValue:Array,optionValue:String,onLoad:Boolean,multiple:Boolean},emits:["changeValue","update:modelValue"],setup(i,{emit:ae}){const ie=ye(),{getModules:J,getModuleByName:ne}=ge(ie),se=ke(),{fetchLookupPaginated:ue}=se,{formatLookupOptions:de,extractFieldinExpressionFormat:ce,extractEntityinExpressionFormat:re}=he(),me=we(()=>Ce(()=>import("./AddableForm-03d34ffe.js"),["assets/AddableForm-03d34ffe.js","assets/index-f956d2f5.js","assets/index-40ff91a8.css","assets/Validate-2e5413e3.js","assets/index-d4bf458e.js"])),h=g({}),p=g([]),B=g(""),x=g({}),q=g({}),V=g(!1),A=g(1),T=g(!0),_=g(!1),U=async v=>{(!e.get(s.value,"formSaving",!1)&&!e.includes(e.get(s.value,"disabled",[]),t.field._id)||!t.formField)&&(V.value||(V.value=!0,O()))},M=g([]),ve=xe(),z=g(!1),w=g([]),t=i,G=ae,W=g(null);_e(()=>{if(_.value=t.multiple,e.get(t.field,"rules.ms_pop_up",!1)&&(_.value=!0),t.formField||(_.value=!0),!e.isEmpty(t.modelValue)&&!e.isNull(t.modelValue)&&!t.formField&&(p.value=e.reduce(t.modelValue,function(d,c,E){return d.push(e.merge(c,{value:c.label})),d},[])),h.value=e.find(J.value,{mainEntity:t.field.relation.entity_id.name}),e.has(t.field,"filterQuery")){var v=t.field.filterQuery,u=v.match(/(\%[a-zA-Z0-9_\:\.\#]*\%)/gi);e.forEach(u,function(d){var c=e.trim(d,"%"),E=ce(c),F=re(c);e.isEmpty(F)&&(F=e.find(J.value,{name:t.module}).mainEntity),F==t.entity&&M.value.push({field:E,entity:F})})}e.has(t.field,"rules.filtered_by")&&(e.isEmpty(t.field.rules.filtered_by)||M.value.push({field:t.field.rules.filtered_by,entity:t.entity})),console.log(t.onLoad),t.onLoad&&O()});const Z=async v=>{A.value=v,O()},$=()=>{V.value=!1};let I=null;const O=async()=>{T.value=!0,I&&I.cancel("Previous search canceled"),I=ee.CancelToken.source();try{let v={fieldId:t.field.uniqueName,page:A.value,moduleName:t.module,search:B.value},u=[];if(t.formField||(v.forReport=!0),!e.isEmpty(M.value)&&t.formField&&e.forEach(M.value,function(d){if(!e.isEmpty(s.value.values.main[d.field])&&!e.isNull(s.value.values.main[d.field])){let c=d.entity+"::"+d.field;v[c]=e.isArray(s.value.values.main[d.field])?e.map(s.value.values.main[d.field],"_id"):s.value.values.main[d.field]._id}else u.push(d.field)}),e.isEmpty(u)){let d=await ue(v,I);x.value=de(d.data,[],t.field),q.value=e.cloneDeep(e.get(d,"meta.pagination",{})),w.value=e.filter(x.value.options,function(c){if(e.includes(e.map(p.value,"_id"),c._id))return!0})}else ve.add({severity:"error",summary:"Error",detail:"Please select "+e.join(u,", "),position:"top-center",life:3e3});T.value=!1}catch(v){ee.isCancel(v)?console.log("Request canceled:",v.message):console.error("Error fetching data:",v)}},H=async()=>{A.value=1,await O()},Q=(v,u)=>{(!e.get(s.value,"formSaving",!1)&&!e.includes(e.get(s.value,"disabled",[]),t.field._id)||!t.formField)&&(_.value?t.formField?e.remove(s.value.values[t.keyName][t.field.name],function(d,c){return c==v}):(e.remove(w.value,function(d,c){return c==v}),e.remove(p.value,function(d,c){return d._id==u}),G("update:modelValue",p.value)):t.formField?s.value.values[t.keyName][t.field.name]=null:p.value=null,G("changeValue"))},K=v=>{if(_.value||$(),!t.formField){let u=e.filter(w.value,function(c){if(!e.includes(e.map(p.value,"_id"),c._id))return!0}),d=e.chain(p.value).filter(function(c){if(!e.includes(e.map(w.value,"_id"),c._id))return!0}).filter(function(c){if(e.includes(e.map(x.value.options,"_id"),c._id))return!0}).map("_id").value();console.log("removed",d),e.remove(p.value,function(c,E){return e.includes(d,c._id)}),p.value=e.concat(p.value,u),G("update:modelValue",p.value)}G("changeValue")},fe=async()=>{(!e.get(s.value,"formSaving",!1)&&!e.includes(e.get(s.value,"disabled",[]),t.field._id)||!t.formField)&&(W.value=ne.value(t.field.addable.moduleName),z.value=!0)},s=t.formField?be("form"):{};return(v,u)=>{const d=N("el-tag"),c=N("el-button"),E=N("el-input"),F=N("Skeleton"),P=N("Listbox"),X=N("el-pagination"),pe=N("Dialog"),Y=Se("click-outside");return o(),n(k,null,[i.formField?le((o(),n("div",{key:0,class:R(["lookupField",{invalid:!l(e).isEmpty(l(e).get(l(s).errors[i.keyName],i.field.name,[]))}])},[l(e).isEmpty(l(s).values[i.keyName][i.field.name])?D("",!0):(o(),n("div",{key:0,class:R(["selectedValue",_.value?"multiple":"single flex align-items-center"]),onClick:U},[_.value?(o(!0),n(k,{key:0},C(p.value,(a,m)=>(o(),b(d,{class:"mr-1",key:a.value,onClose:y=>Q(m,a._id),closable:!l(s).formSaving&&!l(e).includes(l(s).disabled,i.field._id)},{default:S(()=>[te(f(a.value),1)]),_:2},1032,["onClose","closable"]))),128)):(o(),n("div",Fe,[r("div",{class:"material-icons text-white ml-2 lookupSelected",style:j("background:"+l(e).get(h.value,"color","#0091D0"))},f(l(e).get(h.value,"icon","person")),5),r("div",Ne,[r("span",Ee,f(l(s).values[i.keyName][i.field.name].value),1),!l(s).formSaving&&!l(e).includes(l(s).disabled,i.field._id)?(o(),n("span",{key:0,class:"flex flex-colum mr-2 lookupRemoveBtn",onClick:Q},Le)):D("",!0)])]))],2)),L(E,{modelValue:B.value,"onUpdate:modelValue":u[0]||(u[0]=a=>B.value=a),onClick:U,onKeyup:H,class:"lookupInput",disabled:l(s).formSaving||l(e).includes(l(s).disabled,i.field._id),placeholder:"Please search here","suffix-icon":l(oe)},Ve({_:2},[i.field.addable?{name:"append",fn:S(()=>[L(c,{class:R({disabled:l(s).formSaving||l(e).includes(l(s).disabled,i.field._id)})},{default:S(()=>[r("i",{class:"pi pi-plus",onClick:fe})]),_:1},8,["class"])]),key:"0"}:void 0]),1032,["modelValue","disabled","suffix-icon"]),V.value?(o(),n("div",{key:1,class:R(["lookupOverlay p-overlaypanel p-component",{open:V.value==!0,"w-full":!i.inline,"w-auto":i.inline}])},[T.value?(o(!0),n(k,{key:0},C(l(e).fill(Array(10),"i"),(a,m)=>(o(),b(F,{key:m,height:"2rem",width:i.inline?"300px":"100%",class:"m-2",borderRadius:"5px"},null,8,["width"]))),128)):x.value.group?(o(),b(P,{key:1,modelValue:l(s).values[i.keyName][i.field.name],"onUpdate:modelValue":[u[1]||(u[1]=a=>l(s).values[i.keyName][i.field.name]=a),K],multiple:_.value,options:l(e).get(x.value,"options",[]),optionLabel:"value",optionGroupLabel:"label",optionGroupChildren:"options",listStyle:"max-height:300px"},{option:S(a=>[r("div",Be,[r("div",{class:"material-icons text-white mr-2 lookupSelection",style:j("background:"+l(e).get(h.value,"color","#0091D0"))},f(l(e).get(h.value,"icon","person")),5),r("div",Ae,[(o(!0),n(k,null,C(a.option.poupDisplayValues,(m,y)=>(o(),n(k,{key:y},[y==0?(o(),n("span",Pe,f(m),1)):(o(),n("div",Re,f(m),1))],64))),128))])])]),_:1},8,["modelValue","multiple","options"])):(o(),b(P,{key:2,modelValue:l(s).values[i.keyName][i.field.name],"onUpdate:modelValue":[u[2]||(u[2]=a=>l(s).values[i.keyName][i.field.name]=a),K],multiple:_.value,options:l(e).get(x.value,"options",[]),optionLabel:"value",listStyle:"max-height:300px"},{option:S(a=>[r("div",je,[r("div",{class:"material-icons text-white mr-2 lookupSelection",style:j("background:"+l(e).get(h.value,"color","#0091D0"))},f(l(e).get(h.value,"icon","person")),5),r("div",Te,[(o(!0),n(k,null,C(a.option.poupDisplayValues,(m,y)=>(o(),n(k,{key:y},[y==0?(o(),n("span",Ue,f(m),1)):(o(),n("div",Me,f(m),1))],64))),128))])])]),_:1},8,["modelValue","multiple","options"])),r("div",ze,[r("div",Ge,[L(X,{small:"",background:"",layout:"prev, pager, next","default-page-size":10,"current-page":A.value,total:l(e).get(q.value,"total",0),onCurrentChange:Z},null,8,["current-page","total"])])])],2)):D("",!0)],2)),[[Y,$]]):le((o(),n("div",Ie,[l(e).isEmpty(p.value)?D("",!0):(o(),n("div",{key:0,class:"selectedValue multiple",onClick:U},[(o(!0),n(k,null,C(p.value,(a,m)=>(o(),b(d,{class:"mr-1 mb-1",closable:!V.value,key:a.value,onClose:y=>Q(m,a._id)},{default:S(()=>[te(f(a.value),1)]),_:2},1032,["closable","onClose"]))),128))])),L(E,{modelValue:B.value,"onUpdate:modelValue":u[3]||(u[3]=a=>B.value=a),onClick:U,clearable:"",onKeyup:H,class:"lookupInput",placeholder:"Please search here","suffix-icon":l(oe)},null,8,["modelValue","suffix-icon"]),V.value?(o(),n("div",{key:1,class:R(["lookupOverlay p-overlaypanel p-component",{open:V.value==!0,"w-full":!i.inline,"w-auto":i.inline}])},[T.value?(o(!0),n(k,{key:0},C(l(e).fill(Array(10),"i"),(a,m)=>(o(),b(F,{key:m,height:"2rem",width:i.inline?"300px":"100%",class:"m-2",borderRadius:"5px"},null,8,["width"]))),128)):x.value.group?(o(),b(P,{key:1,modelValue:w.value,"onUpdate:modelValue":[u[4]||(u[4]=a=>w.value=a),K],multiple:!0,dataKey:"_id",options:l(e).get(x.value,"options",[]),optionLabel:"value",optionGroupLabel:"label",optionGroupChildren:"options",listStyle:"max-height:300px"},{option:S(a=>[r("div",Oe,[r("div",{class:"material-icons text-white mr-2 lookupSelection",style:j("background:"+l(e).get(h.value,"color","#0091D0"))},f(l(e).get(h.value,"icon","person")),5),r("div",Ke,[(o(!0),n(k,null,C(a.option.poupDisplayValues,(m,y)=>(o(),n(k,{key:y},[y==0?(o(),n("span",qe,f(m),1)):(o(),n("div",$e,f(m),1))],64))),128))])])]),_:1},8,["modelValue","options"])):(o(),b(P,{key:2,modelValue:w.value,"onUpdate:modelValue":[u[5]||(u[5]=a=>w.value=a),K],multiple:!0,dataKey:"_id",options:l(e).get(x.value,"options",[]),optionLabel:"value",listStyle:"max-height:300px"},{option:S(a=>[r("div",Qe,[r("div",{class:"material-icons text-white mr-2 lookupSelection",style:j("background:"+l(e).get(h.value,"color","#0091D0"))},f(l(e).get(h.value,"icon","person")),5),r("div",Je,[(o(!0),n(k,null,C(a.option.poupDisplayValues,(m,y)=>(o(),n(k,{key:y},[y==0?(o(),n("span",We,f(m),1)):(o(),n("div",Ze,f(m),1))],64))),128))])])]),_:1},8,["modelValue","options"])),r("div",He,[r("div",Xe,[L(X,{small:"",background:"",layout:"prev, pager, next","default-page-size":10,"current-page":A.value,total:l(e).get(q.value,"total",0),onCurrentChange:Z},null,8,["current-page","total"])])])],2)):D("",!0)])),[[Y,$]]),i.field.addable?(o(),b(pe,{key:2,visible:z.value,"onUpdate:visible":u[7]||(u[7]=a=>z.value=a),modal:"",header:"New "+l(e).startCase(l(e).get(W.value,"name","")),style:{width:"40vw"},draggable:"",breakpoints:{"1199px":"75vw","575px":"90vw"}},{default:S(()=>[L(l(me),{moduleName:i.field.addable.moduleName,formPage:"create",onClose:u[6]||(u[6]=a=>z.value=!1)},null,8,["moduleName"])]),_:1},8,["visible","header"])):D("",!0)],64)}}};export{el as default};
