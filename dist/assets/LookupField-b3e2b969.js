import{B as ve,s as pe,a4 as ye,a5 as ge,r as v,a as ke,E as _e,a2 as e,q as Z,b2 as he,c as N,V as be,o as n,j as r,W as xe,n as j,i as t,F as k,k as C,d as w,w as V,g as H,t as _,e as p,x as K,m as D,f as M,aG as Se,c3 as Ne,I as Ve,J as Fe}from"./index-62853e10.js";const Ee={key:1,class:"flex align-items-center lookupSelected",style:{width:"100%"}},we={class:"flex justify-content-between align-items-center lookupSelected",style:{width:"100%"}},Ce={class:"flex flex-colum ml-2 lookupSelected"},De=p("i",{class:"pi pi-times lookupRemoveBtn"},null,-1),Le=[De],Be={class:"flex align-items-center lookupSelection"},Ae={class:"lookupSelection"},Pe={key:0,class:"font-medium lookupSelection"},Re={key:1,class:"text-sm text-color-secondary lookupSelection"},Te={class:"flex align-items-center lookupSelection"},je={class:"lookupSelection"},Me={key:0,class:"font-medium lookupSelection"},ze={key:1,class:"text-sm text-color-secondary lookupSelection"},Ie={class:"flex justify-content-center"},Oe={class:"flex flex-column mt-1"},qe={__name:"LookupField",props:{field:Object,keyName:String,module:String,inline:Boolean,entity:String,formField:Boolean,modelValue:Array,optionValue:String,onLoad:Boolean,multiple:Boolean},emits:["changeValue","update:modelValue"],setup(s,{emit:X}){const Y=ve(),{getModules:$,getModuleByName:ee}=pe(Y),le=ye(),{fetchLookupPaginated:ae}=le,{formatLookupOptions:te,extractFieldinExpressionFormat:ie,extractEntityinExpressionFormat:oe}=ge(),ne=Ve(()=>Fe(()=>import("./AddableForm-e9f0078c.js"),["assets/AddableForm-e9f0078c.js","assets/index-62853e10.js","assets/index-40ff91a8.css","assets/Validate-97e58e3d.js","assets/index-d4681dd1.js"])),b=v({}),f=v([]),z=v(""),h=v({}),I=v({}),x=v(!1),L=v(1),O=v(!0),y=v(!1),U=async c=>{(!e.get(i.value,"formSaving",!1)&&!e.includes(e.get(i.value,"disabled",[]),l.field._id)||!l.formField)&&(x.value||(x.value=!0,T()))},B=v([]),ue=ke(),A=v(!1),m=v(null),l=s,P=X,Q=v(null);_e(()=>{if(y.value=l.multiple,e.get(l.field,"rules.ms_pop_up",!1)&&(y.value=!0),l.formField||(y.value=!0),m.value=l.formField?y.value?[]:{}:[],!e.isEmpty(l.modelValue)&&!e.isNull(l.modelValue)&&!l.formField&&(f.value=e.reduce(l.modelValue,function(o,a,F){return o.push(e.merge(a,{value:a.label})),o},[])),b.value=e.find($.value,{mainEntity:l.field.relation.entity_id.name}),e.has(l.field,"filterQuery")){var c=l.field.filterQuery,u=c.match(/(\%[a-zA-Z0-9_\:\.\#]*\%)/gi);e.forEach(u,function(o){var a=e.trim(o,"%"),F=ie(a),E=oe(a);e.isEmpty(E)&&(E=e.find($.value,{name:l.module}).mainEntity),E==l.entity&&B.value.push({field:F,entity:E})})}e.has(l.field,"rules.filtered_by")&&(e.isEmpty(l.field.rules.filtered_by)||B.value.push({field:l.field.rules.filtered_by,entity:l.entity})),console.log(l.onLoad),l.onLoad&&T()});const se=async c=>{L.value=c,T()},J=()=>{x.value=!1};let R=null;const T=async()=>{O.value=!0,R&&R.cancel("Previous search canceled"),R=Z.CancelToken.source();try{let c={fieldId:l.field.uniqueName,page:L.value,moduleName:l.module,search:z.value},u=[];if(l.formField||(c.forReport=!0),!e.isEmpty(B.value)&&l.formField&&e.forEach(B.value,function(o){if(!e.isEmpty(i.value.values.main[o.field])&&!e.isNull(i.value.values.main[o.field])){let a=o.entity+"::"+o.field;c[a]=e.isArray(i.value.values.main[o.field])?e.map(i.value.values.main[o.field],"_id"):i.value.values.main[o.field]._id}else u.push(o.field)}),e.isEmpty(u)){let o=await ae(c,R);h.value=te(o.data,[],l.field),I.value=e.cloneDeep(e.get(o,"meta.pagination",{})),l.formField?y.value?m.value=e.filter(h.value.options,function(a){if(e.includes(e.map(i.value.values[l.keyName][l.field.name],"_id"),a._id))return!0}):e.isEmpty(i.value.values[l.keyName][l.field.name])||(m.value=e.find(h.value.options,function(a){if(i.value.values[l.keyName][l.field.name]._id==a._id)return!0})):m.value=e.filter(h.value.options,function(a){if(e.includes(e.map(f.value,"_id"),a._id))return!0})}else ue.add({severity:"error",summary:"Error",detail:"Please select "+e.join(u,", "),position:"top-center",life:3e3});O.value=!1}catch(c){Z.isCancel(c)?console.log("Request canceled:",c.message):console.error("Error fetching data:",c)}},de=async()=>{L.value=1,await T()},q=(c,u)=>{(!e.get(i.value,"formSaving",!1)&&!e.includes(e.get(i.value,"disabled",[]),l.field._id)||!l.formField)&&(y.value?l.formField?(e.remove(m.value,function(o,a){return a==c}),e.remove(i.value.values[l.keyName][l.field.name],function(o,a){return o._id==u})):(e.remove(m.value,function(o,a){return a==c}),e.remove(f.value,function(o,a){return o._id==u}),P("update:modelValue",f.value)):l.formField?i.value.values[l.keyName][l.field.name]=null:f.value=null,P("changeValue"))},W=c=>{if(!y.value)i.value.values[l.keyName][l.field.name]=m.value,J();else if(l.formField){let u=e.filter(m.value,function(a){if(!e.includes(e.map(i.value.values[l.keyName][l.field.name],"_id"),a._id))return!0}),o=e.chain(i.value.values[l.keyName][l.field.name]).filter(function(a){if(!e.includes(e.map(m.value,"_id"),a._id))return!0}).filter(function(a){if(e.includes(e.map(h.value.options,"_id"),a._id))return!0}).map("_id").value();e.isEmpty(o)||e.remove(i.value.values[l.keyName][l.field.name],function(a,F){return e.includes(o,a._id)}),e.isNull(i.value.values[l.keyName][l.field.name])&&(i.value.values[l.keyName][l.field.name]=[]),i.value.values[l.keyName][l.field.name]=e.concat(i.value.values[l.keyName][l.field.name],u)}else{let u=e.filter(m.value,function(a){if(!e.includes(e.map(f.value,"_id"),a._id))return!0}),o=e.chain(f.value).filter(function(a){if(!e.includes(e.map(m.value,"_id"),a._id))return!0}).filter(function(a){if(e.includes(e.map(h.value.options,"_id"),a._id))return!0}).map("_id").value();e.isEmpty(o)||e.remove(f.value,function(a,F){return e.includes(o,a._id)}),f.value=e.concat(f.value,u),P("update:modelValue",f.value)}P("changeValue")},re=async()=>{(!e.get(i.value,"formSaving",!1)&&!e.includes(e.get(i.value,"disabled",[]),l.field._id)||!l.formField)&&(Q.value=ee.value(l.field.addable.moduleName),A.value=!0)},i=l.formField?he("form"):{};return(c,u)=>{const o=N("el-tag"),a=N("el-button"),F=N("el-input"),E=N("Skeleton"),G=N("Listbox"),ce=N("el-pagination"),me=N("Dialog"),fe=be("click-outside");return n(),r(k,null,[xe((n(),r("div",{class:j(["lookupField",{invalid:!t(e).isEmpty(t(e).get(t(i),"errors."+s.keyName+"."+s.field.name,[]))}])},[s.formField?(n(),r(k,{key:0},[t(e).isEmpty(t(i).values[s.keyName][s.field.name])?D("",!0):(n(),r("div",{key:0,class:j(["selectedValue",y.value?"multiple":"single flex align-items-center"]),onClick:U},[y.value?(n(!0),r(k,{key:0},C(t(i).values[s.keyName][s.field.name],(d,g)=>(n(),w(o,{class:"mr-1 mb-1",closable:!x.value&&!t(i).formSaving&&!t(e).includes(t(i).disabled,s.field._id),key:d.value,onClose:S=>q(g,d._id)},{default:V(()=>[H(_(d.value),1)]),_:2},1032,["closable","onClose"]))),128)):(n(),r("div",Ee,[p("div",{class:"material-icons text-white ml-2 lookupSelected",style:K("background:"+t(e).get(b.value,"color","#0091D0"))},_(t(e).get(b.value,"icon","person")),5),p("div",we,[p("span",Ce,_(t(i).values[s.keyName][s.field.name].value),1),!t(i).formSaving&&!t(e).includes(t(i).disabled,s.field._id)?(n(),r("span",{key:0,class:"flex flex-colum mr-2 lookupRemoveBtn",onClick:q},Le)):D("",!0)])]))],2))],64)):(n(),r(k,{key:1},[t(e).isEmpty(f.value)?D("",!0):(n(),r("div",{key:0,class:"selectedValue multiple",onClick:U},[(n(!0),r(k,null,C(f.value,(d,g)=>(n(),w(o,{class:"mr-1 mb-1",closable:!x.value,key:d.value,onClose:S=>q(g,d._id)},{default:V(()=>[H(_(d.value),1)]),_:2},1032,["closable","onClose"]))),128))]))],64)),M(F,{modelValue:z.value,"onUpdate:modelValue":u[0]||(u[0]=d=>z.value=d),onClick:U,clearable:"",onKeyup:de,class:"lookupInput",disabled:t(e).get(t(i),"formSaving",!1)||t(e).includes(t(e).get(t(i),"disabled",[]),s.field._id),placeholder:"Please search here","suffix-icon":t(Ne)},Se({_:2},[s.field.addable&&s.formField?{name:"append",fn:V(()=>[M(a,{class:j({disabled:t(i).formSaving||t(e).includes(t(i).disabled,s.field._id)})},{default:V(()=>[p("i",{class:"pi pi-plus",onClick:re})]),_:1},8,["class"])]),key:"0"}:void 0]),1032,["modelValue","disabled","suffix-icon"]),x.value?(n(),r("div",{key:2,class:j(["lookupOverlay p-overlaypanel p-component",{open:x.value==!0,"w-full":!s.inline,"w-auto":s.inline}])},[O.value?(n(!0),r(k,{key:0},C(t(e).fill(Array(10),"i"),(d,g)=>(n(),w(E,{key:g,height:"2rem",width:s.inline?"300px":"100%",class:"m-2",borderRadius:"5px"},null,8,["width"]))),128)):h.value.group?(n(),w(G,{key:1,modelValue:m.value,"onUpdate:modelValue":[u[1]||(u[1]=d=>m.value=d),W],multiple:y.value,dataKey:"_id",options:t(e).get(h.value,"options",[]),optionLabel:"value",optionGroupLabel:"label",optionGroupChildren:"options",listStyle:"max-height:300px"},{option:V(d=>[p("div",Be,[p("div",{class:"material-icons text-white mr-2 lookupSelection",style:K("background:"+t(e).get(b.value,"color","#0091D0"))},_(t(e).get(b.value,"icon","person")),5),p("div",Ae,[(n(!0),r(k,null,C(d.option.poupDisplayValues,(g,S)=>(n(),r(k,{key:S},[S==0?(n(),r("span",Pe,_(g),1)):(n(),r("div",Re,_(g),1))],64))),128))])])]),_:1},8,["modelValue","multiple","options"])):(n(),w(G,{key:2,modelValue:m.value,"onUpdate:modelValue":[u[2]||(u[2]=d=>m.value=d),W],multiple:y.value,dataKey:"_id",options:t(e).get(h.value,"options",[]),optionLabel:"value",listStyle:"max-height:300px"},{option:V(d=>[p("div",Te,[p("div",{class:"material-icons text-white mr-2 lookupSelection",style:K("background:"+t(e).get(b.value,"color","#0091D0"))},_(t(e).get(b.value,"icon","person")),5),p("div",je,[(n(!0),r(k,null,C(d.option.poupDisplayValues,(g,S)=>(n(),r(k,{key:S},[S==0?(n(),r("span",Me,_(g),1)):(n(),r("div",ze,_(g),1))],64))),128))])])]),_:1},8,["modelValue","multiple","options"])),p("div",Ie,[p("div",Oe,[M(ce,{small:"",background:"",layout:"prev, pager, next","default-page-size":t(e).get(I.value,"per_page",10),"current-page":L.value,total:t(e).get(I.value,"total",0),onCurrentChange:se},null,8,["default-page-size","current-page","total"])])])],2)):D("",!0)],2)),[[fe,J]]),s.field.addable?(n(),w(me,{key:0,visible:A.value,"onUpdate:visible":u[4]||(u[4]=d=>A.value=d),modal:"",header:"New "+t(e).startCase(t(e).get(Q.value,"name","")),style:{width:"40vw"},draggable:"",breakpoints:{"1199px":"75vw","575px":"90vw"}},{default:V(()=>[M(t(ne),{moduleName:s.field.addable.moduleName,formPage:"create",onClose:u[3]||(u[3]=d=>A.value=!1)},null,8,["moduleName"])]),_:1},8,["visible","header"])):D("",!0)],64)}}};export{qe as default};
