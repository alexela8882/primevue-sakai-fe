import{a4 as re,B as de,K as ce,O as me,a5 as fe,s as S,a as ve,r as _,a2 as a,aa as ge,E as pe,Y as _e,G as ke,c as B,o,j as n,e as E,d as v,w as y,F as r,k as h,i as s,m as F,S as ye,g as x,f as he,I as N,J as A}from"./index-f956d2f5.js";import{v as Fe}from"./Validate-2e5413e3.js";import{u as be}from"./index-d4bf458e.js";const Se={class:"relative min-h-full p-3"},xe={class:"sticky bottom-0 right-0 py-2 surface-50"},De={class:"flex justify-content-end gap-2 px-3 py-1"},Te={__name:"Form",props:{config:Object},setup(d){const O=N(()=>A(()=>import("./Field-7d68320f.js"),["assets/Field-7d68320f.js","assets/index-f956d2f5.js","assets/index-40ff91a8.css","assets/Validate-2e5413e3.js","assets/Editor-92f51c1d.js","assets/Field-7433004a.css"])),I=N(()=>A(()=>import("./FormPanel-1aa7d1d1.js"),["assets/FormPanel-1aa7d1d1.js","assets/index-f956d2f5.js","assets/index-40ff91a8.css","assets/FormPanel-d63a1f32.css"])),j=N(()=>A(()=>import("./QuoteLineItem-b62fad09.js"),["assets/QuoteLineItem-b62fad09.js","assets/index-f956d2f5.js","assets/index-40ff91a8.css"])),t=d,V=re(),U=be(),q=de(),W=ce(),G=me(),{formatLookupOptions:Pe,getPicklistFields:Ee,getLookupFields:Ne,transformFormValues:b,transformDate:Ae,transformForSaving:H,getAllHiddenFieldsAndPanels:J,controllingFieldChecker:Ve,getAllDisabledFields:K,checkSetValRule:Q}=fe(),{fetchPicklist:qe,fetchLookup:we,saveForm:Y,setFormReset:w,saveFormValues:X}=V,{getCachedFormData:Z,getFormReset:C}=S(V),{getItem:D}=S(U),{fetchModuleFields:$,fetchModulePanels:ee}=q,{removeTab:ae}=W,{getModuleByName:k}=S(q),{getAuthUser:M}=S(G),{validateForm:le,errorChecker:te}=Fe(),R=ve(),oe=_(a.fill(Array(10),1)),c=_(!0);_(!1);const e=_({fields:[],panels:[],values:{main:{}},lookup:{},errors:{main:{}},hidden:{fields:[],panels:[]},disabled:[],formName:t.config.name,formSaving:!1}),i=_();_([]),ge("form",e),pe(async()=>{console.log("mounted",c.value);let u=Z.value(t.config.name);if(i.value=a.includes(t.config.name,"edit")?"update":"create",console.log("tmpData",u),u)e.value=a.merge(e.value,a.cloneDeep(u)),t.config.name==C.value&&(e.value.values.main=b(e.value.fields,D.value,i.value),w(""));else{a.isEmpty(k.value(t.config._module).fields)&&await $(k.value(t.config._module).mainEntity),a.isEmpty(k.value(t.config._module).panels)&&await ee(t.config._module);let m=a.cloneDeep(k.value(t.config._module));e.value.fields=m.fields,e.value.panels=m.panels,se()}c.value=!1}),_e(()=>{console.log("before unmount"),Y(e.value)}),ke(()=>C.value,(u,m)=>{u==t.config.name&&(e.value.values.main=b(t.config.module.fields),w(""))});const se=()=>{let u=a.chain(e.value.fields).filter({quick:!0}).map("_id").value(),m=i.value=="create"?null:D.value.data;console.log(m);let g=b(e.value.fields,m,i.value),p=Q(e.value.fields,g,k.value(t.config._module).mainEntity);if(e.value.values.main=a.merge(a.cloneDeep(g),a.cloneDeep(p)),e.value.hidden=J(e.value.panels,e.value.fields,e.value.values.main,i.value),e.value.disabled=K(e.value.fields,e.value.values.main,i.value),t.config._module=="defectreports"&&i.value=="update",t.config._module=="rpworkorders"&&!a.includes(M.value.roles,"rpwo_operator")&&!a.includes(M.value.roles,"crm_admin")&&(e.value.disabled=a.union(e.value.disabled,["rpworkorder_operator_status_id"])),t.config._module=="salesopportunities"&&i.value=="update"){let l=a.find(e.value.fields,{uniqueName:"salesopportunity_account_id"});e.value.disabled=a.union(e.value.disabled,[l._id])}a.forEach(e.value.panels,function(l,f){e.value.panels[f].quick=!1,a.forEach(l.sections,function(P,T){e.value.panels[f].sections[T].quick=!1;let z=P.field_ids[0];P.field_ids.length>1&&z.concat(P.field_ids[1]),a.filter(z,function(ne){if(a.includes(u,ne))return!0}).length>0&&(e.value.panels[f].quick=!0,e.value.panels[f].sections[T].quick=!0)}),i.value=="create"&&(e.value.values[l.panelName]=[],e.value.errors[l.panelName]=[])}),console.log(c.value),console.log("done initialize")},L=()=>{c.value=!0;let u=a.includes(t.config.name,"edit")?"update":"create";e.value.values.main=b(e.value.fields,D.value,u),c.value=!1},ie=async()=>{let u=a.get(t.config,"maximized",!1);if(e.value.formSaving=!0,e.value.errors.main=le(e.value.values.main,e.value.fields,e.value.hidden.fields,u),te(e.value.errors.main)){let g=H(e.value.values.main,e.value.fields,u);(await X(g,t.config.base_module)).status==200&&(R.add({severity:"success",summary:"Success Message",detail:"Record added",life:3e3}),e.value.formSaving=!1,ue(t.config))}else R.add({severity:"error",summary:"Error Message",detail:"Please check the form again",life:3e3}),e.value.formSaving=!1},ue=async u=>{await ae(u)};return(u,m)=>{const g=B("Skeleton"),p=B("el-button");return o(),n(r,null,[E("div",Se,[c.value?F("",!0):(o(),v(ye,{key:0},{fallback:y(()=>[(o(!0),n(r,null,h(oe.value,(l,f)=>(o(),v(g,{key:f,height:"2rem",class:"mb-2",borderRadius:"16px"}))),128))]),default:y(()=>[s(a).filter(e.value.panels,{quick:!0}).length==1&&s(a).get(d.config,"maximized",!1)==!1?(o(!0),n(r,{key:0},h(s(a).filter(e.value.fields,{quick:!0}),l=>(o(),n(r,{key:l._id},[s(a).includes(e.value.hidden.fields,l._id)?F("",!0):(o(),v(s(O),{key:0,keyName:"main",config:l,module:d.config._module,formPage:i.value},null,8,["config","module","formPage"]))],64))),128)):(o(),n(r,{key:1},[(o(!0),n(r,null,h(s(a).filter(e.value.panels,function(l){if(!s(a).includes(e.value.hidden.panels,l.panelName)&&s(a).endsWith(l.controllerMethod,"@index")&&(s(a).get(d.config,"maximized",!1)==!1&&l.quick||s(a).get(d.config,"maximized",!1)==!0))return!0}),l=>(o(),v(s(I),{key:l._id,panel:l,quickAdd:!s(a).get(d.config,"maximized",!1),module:d.config._module,formPage:i.value},null,8,["panel","quickAdd","module","formPage"]))),128)),i.value=="create"?(o(!0),n(r,{key:0},h(s(a).filter(e.value.panels,function(l){if(!s(a).includes(e.value.hidden.panels,l.panelName)&&s(a).endsWith(l.controllerMethod,"@show")&&s(a).get(d.config,"maximized",!1)==!0)return!0}),l=>(o(),n(r,{key:l._id},[s(a).includes(["SalesOpptItem"],l.entityName)?(o(!0),n(r,{key:0},h(l.sections,f=>(o(),n("div",{key:f._id,class:"flex flex-column px-1 py-2 mt-2"},[l.entityName=="SalesOpptItem"?(o(),v(s(j),{key:0,panel:l,module:d.config._module,formPage:i.value},null,8,["panel","module","formPage"])):F("",!0)]))),128)):F("",!0)],64))),128)):F("",!0)],64))]),_:1}))]),E("div",xe,[E("div",De,[i.value=="create"?(o(),v(p,{key:0,onClick:L,disabled:c.value||e.value.formSaving},{default:y(()=>[x("Reset")]),_:1},8,["disabled"])):(o(),v(p,{key:1,onClick:L,disabled:c.value||e.value.formSaving},{default:y(()=>[x("Cancel")]),_:1},8,["disabled"])),he(p,{type:"primary",onClick:ie,disabled:c.value||e.value.formSaving,loading:e.value.formSaving},{default:y(()=>[i.value=="create"?(o(),n(r,{key:0},[x("Save")],64)):(o(),n(r,{key:1},[x("Update")],64))]),_:1},8,["disabled","loading"])])])],64)}}};export{Te as default};
