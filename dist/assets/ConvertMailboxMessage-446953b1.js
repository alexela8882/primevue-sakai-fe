import{r,B as xe,s as O,G as $,E as Me,c as V,o as i,j as d,e as o,f as v,w as h,t as c,i as n,m as f,F as I,k as q,ab as Ve,n as he,d as T,S as H,a1 as we,I as ke,J as Ce}from"./index-f956d2f5.js";import{u as Ne,c as E,a as K}from"./index.esm-2bf7ebf4.js";import{u as Ie}from"./index-d4bf458e.js";import{u as qe}from"./index-d6963ca2.js";import{T as W}from"./TwoColumnList-0104ad4a.js";const Ee={class:"flex flex-column gap-3 m-4"},Se={class:"flex align-items-center"},Fe=o("label",{class:"ml-2"},"Choose existing",-1),Be={class:"flex align-items-center"},De={key:0},je={class:"flex flex-column gap-3 m-4"},Oe={class:"flex align-items-center"},$e=o("label",{class:"ml-2"},"Create new",-1),Te=o("h3",null,"Quick add",-1),Re=o("div",{class:"text-l text-700 font-bold bg-primary-50 p-2 mb-4"},"All required fields",-1),Le={class:"grid"},Ae={class:"p-float-label"},Ue={key:0,class:"text-red-600"},Pe=o("h3",null,"Detailed add",-1),ze={key:0},Ge={class:"text-l text-700 font-bold bg-primary-50 p-2"},Je={class:"flex flex-column mt-4"},Qe={key:0},He={key:1},Ke={class:"p-2 border-top-1 border-200"},We={class:"flex align-items-center justify-content-end my-2 gap-2"},il={__name:"ConvertMailboxMessage",props:{token:Object,convertModule:Object,mailboxMessage:Object},emits:["update-timeout"],setup(X,{emit:Y}){const R=ke(()=>Ce(()=>import("./SectionFields-50ec7a24.js"),["assets/SectionFields-50ec7a24.js","assets/index-f956d2f5.js","assets/index-40ff91a8.css","assets/index-d4bf458e.js"])),m=X,Z=Y;r({test:"initial value"}),r();const w=r({}),y=r({}),L=r(!0),A=r([]),S=r([]),ee=r(0),x=r([]),u=r(null),_=r(),{values:Xe,errors:M,setErrors:Ye,setFieldError:le,ErrorBag:Ze,defineComponentBinds:F,isSubmitting:oe,setFieldValue:te,handleSubmit:ae,meta:k}=Ne({});F("field0"),r({field_1:F("test_fields.field_1")});const U=xe(),se=Ie(),P=qe(),{getEntityByName:z,getFieldDetailsByUname:ne,getCollection:ie,getModule:de,convertMailboxLoading:B}=O(U),{getItemPanels:ue,getRelatedListsByCname:el}=O(se),{getMailFolderMessages:re,getConversationMessages:ce}=O(P),{fetchConversationMessages:me}=P,{fetchModule:ve,convertMailboxToInquiry:_e,insertModuleFromMailbox:pe}=U,G=async()=>{B.value=!1,await ve(m.convertModule.name),x.value=de.value.fields,x.value.map(e=>Object.assign(e,{...e,data:{value:null}}));const l={};x.value.map(e=>{if(e.rules&&e.rules.required){l[e.uniqueName]=E().label(e.label).required();let s=Object.assign({},{[e.uniqueName]:E().label(e.label).required()});console.log(s)}else l[e.uniqueName]=E().label(e.label).nullable();y.value[e.uniqueName]=F(`${e.uniqueName}`),te(`${e.uniqueName}`,null)}),w.value=l,w.value=K(l),console.log(w.value),S.value=x.value.filter(e=>e.rules&&e.rules.required),ee.value=S.value.length,K().shape({field_1:E().label("Field 1").required()}),A.value=ue.value.filter(e=>e.controllerMethod.includes("@index")),setTimeout(()=>{L.value=!1,Z("update-timeout")},100)},fe=async()=>{_.value==1?J(null):be()},J=async l=>{let e=null;l!==null?e=l:e=u.value;const s=z.value(m.convertModule.name);let a=null;const p=m.mailboxMessage.from.emailAddress.name,b=m.mailboxMessage.from.emailAddress.address;await me(m.mailboxMessage,m.token),a=Object.assign({},{_id:`${Date.now()}`,owner_id:localStorage.getItem("auth_id"),source_id:"Email",dateRequested:"01-06-2024",dateResponded:"01-06-2024",assigned_to_id:e.owner_id,description:`This is a test from converted mailbox - ${Date.now()}`,type_id:s.mainEntity,link_id:e._id,email_id:m.mailboxMessage.id,name:p,email:b,conversation_id:m.mailboxMessage.conversationId,conversations:ce.value}),ge(a)},be=async()=>{const l=await C();if(l.inner)console.log(moduleRes);else{let s={_id:Date.now()};Object.keys(l).forEach(b=>{if(l[b]!==null){const N=ne.value(b).name,t=l[b];s[N]=t}}),s.owner_id={_id:"5bb104ed678f71061f6451f8",firstName:"Ninoy",lastName:"Cahayon",email:"ninoy.cahayon@escolifesciences.com"};const a={module:m.convertModule,data:s},p=await pe(a);p&&p.status===200&&J(a.data)}},C=ae((l,e)=>{Object.keys(y.value).forEach((s,a)=>{y.value[s].modelValue!==null&&le(s,null)});try{return w.value.validateSync(l,{abortEarly:!1}),l}catch(s){return s.inner.map(a=>{a.path+"",a.message,e.setFieldError(a.path,a.message)}),s}}),ge=async l=>{const e=await _e(l);if(e&&e.status===200){const s=e.data.collection.data.find(a=>a.email_id==l.email_id)._id;re.value.value.find(a=>{if(a.id===l.email_id){let p={...a,convertedToInquiry:!0,inquiry_id:s};Object.assign(a,p)}})}};return $(()=>_.value,(l,e)=>{l==2&&(u.value=null)}),$(()=>u.value,(l,e)=>{l&&(_.value=1)}),$(()=>m.convertModule,(l,e)=>{console.log(l),G()}),Me(()=>{G(),console.log(z.value(m.convertModule.name))}),(l,e)=>{const s=V("RadioButton"),a=V("Dropdown"),p=V("Divider"),b=V("InputText"),N=V("Button");return i(),d("div",null,[o("div",Ee,[o("div",Se,[v(s,{modelValue:_.value,"onUpdate:modelValue":e[0]||(e[0]=t=>_.value=t),inputId:"ingredient1",name:"1",value:1,disabled:""},null,8,["modelValue"]),Fe]),v(a,{modelValue:u.value,"onUpdate:modelValue":e[1]||(e[1]=t=>u.value=t),options:n(ie).data,optionLabel:"owner_id.email",optionvalue:"_id",filter:"",placeholder:"Select",class:"w-full"},{option:h(t=>[o("div",Be,[o("div",null,c(t.option.owner_id.email)+" ("+c(t.option.company)+")",1)])]),_:1},8,["modelValue","options"]),u.value?(i(),d("div",De,[o("div",null,c(u.value.firstName)+" "+c(u.value.lastName),1),o("div",null," Owner: "+c(u.value.owner_id.firstName)+" "+c(u.value.owner_id.lastName),1),o("div",null,"Company: "+c(u.value.company),1),o("div",null,"Status: "+c(u.value.status_id),1),o("div",null,"Country: "+c(u.value.country_id.name),1)])):f("",!0)]),v(p),o("div",je,[o("div",Oe,[v(s,{modelValue:_.value,"onUpdate:modelValue":e[2]||(e[2]=t=>_.value=t),name:"2",value:2},null,8,["modelValue"]),$e]),o("div",null,[Te,Re,o("div",Le,[(i(!0),d(I,null,q(S.value,(t,D)=>(i(),d("div",{key:D,class:"col-6"},[o("span",Ae,[v(b,Ve({"onUpdate:modelValue":e[3]||(e[3]=g=>n(C)())},y.value[t.uniqueName],{class:["w-full border-left-3",`${!n(M)[t.uniqueName]&&n(k).touched?"border-green-600":"border-red-600"}`]}),null,16,["class"]),o("label",null,c(t.label),1)]),n(M)[t.uniqueName]?(i(),d("small",Ue,c(n(M)[t.uniqueName]),1)):f("",!0)]))),128))]),Pe,(i(!0),d(I,null,q(A.value,(t,D)=>(i(),d("div",{key:D,class:"flex flex-column gap-1"},[(i(!0),d(I,null,q(t.sections,(g,Q)=>(i(),d("div",{key:Q,class:he(`${Q!==0&&"mt-4"}`)},[o("div",null,[o("div",null,[g.sectionLabel?(i(),d("div",ze,[o("div",Ge,c(g.sectionLabel),1)])):f("",!0)]),o("div",Je,[t.controllerMethod.indexOf("@index")>-1?(i(),d("div",Qe,[g.field_ids.length>0?(i(),T(H,{key:0},{fallback:h(()=>[v(W)]),default:h(()=>[v(n(R),{mode:"edit",source:"Email",fieldIds:g.field_ids,newModuleFields:x.value,moduleValidationInputs:y.value,moduleValidationErrors:n(M),moduleValidationMeta:n(k),onValidateSyncFunc:e[4]||(e[4]=j=>n(C)())},null,8,["fieldIds","newModuleFields","moduleValidationInputs","moduleValidationErrors","moduleValidationMeta"])]),_:2},1024)):f("",!0),g.additional_fields.length>0?(i(),d("div",He,[(i(!0),d(I,null,q(g.additional_fields,(j,ye)=>(i(),d("div",{key:ye},[j.ids.length>0?(i(),T(H,{key:0},{fallback:h(()=>[v(W)]),default:h(()=>[v(n(R),{mode:"edit",source:"Email",fieldIds:j.ids,newModuleFields:x.value,moduleValidationInputs:y.value,moduleValidationErrors:n(M),moduleValidationMeta:n(k),onValidateSyncFunc:e[5]||(e[5]=ll=>n(C)())},null,8,["fieldIds","newModuleFields","moduleValidationInputs","moduleValidationErrors","moduleValidationMeta"])]),_:2},1024)):f("",!0)]))),128))])):f("",!0)])):f("",!0)])])],2))),128))]))),128))])]),L.value?f("",!0):(i(),T(we,{key:0,to:".mailbox-dialog-footer"},[o("div",Ke,[o("div",We,[v(N,{onClick:e[6]||(e[6]=t=>l.$emit("trigger-dialog")),disabled:n(B),outlined:"",label:"Cancel",class:"border-round-3xl py-2 px-4 border-color-primary",size:"small"},null,8,["disabled"]),v(N,{onClick:e[7]||(e[7]=t=>fe()),disabled:!_.value||_.value==2&&!n(k).valid,loading:n(B)||n(oe),label:"Proceed",class:"border-round-3xl py-2 px-4"},null,8,["disabled","loading"])])])]))])}}};export{il as default};
